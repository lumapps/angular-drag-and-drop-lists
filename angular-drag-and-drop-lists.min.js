angular.module("dndLists",[]).service("dndService",function(){function e(){return t}function n(){return a}function r(e){t=e,a=e.outerHeight()}var t,a;return{getDraggingElement:e,getDraggingElementHeight:n,setDraggingElement:r}}).directive("dndDraggable",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround","dndService",function(e,n,r,t,a){return function(d,i,o){i.attr("draggable","true"),o.dndDisableIf&&d.$watch(o.dndDisableIf,function(e){i.attr("draggable",!e)}),i.on("dragstart",function(g){g=g.originalEvent||g,a.setDraggingElement(angular.isDefined(o.dndTarget)?i.find(o.dndTarget):i),g.dataTransfer.setData("Text",angular.toJson(d.$eval(o.dndDraggable))),g.dataTransfer.effectAllowed=o.dndEffectAllowed||"move",i.addClass("dndDragging"),n(function(){i.addClass("dndDraggingSource")},0),r.dropEffect="none",t.isDragging=!0,t.dragType=o.dndType?d.$eval(o.dndType):void 0,e(o.dndDragstart)(d,{event:g}),g.stopPropagation()}),i.on("dragend",function(n){n=n.originalEvent||n;var a=r.dropEffect;d.$apply(function(){switch(a){case"move":e(o.dndMoved)(d,{event:n});break;case"copy":e(o.dndCopied)(d,{event:n})}}),i.removeClass("dndDragging"),i.removeClass("dndDraggingSource"),t.isDragging=!1,n.stopPropagation()}),i.on("click",function(n){(angular.isUndefined(o.dndDisableIf)||!d.$eval(o.dndDisableIf))&&(n=n.originalEvent||n,d.$apply(function(){e(o.dndSelected)(d,{event:n})}),n.stopPropagation())}),i.on("selectstart",function(){return angular.isUndefined(o.dndDisableIf)||!d.$eval(o.dndDisableIf)?(this.dragDrop&&this.dragDrop(),!1):void 0})}}]).directive("dndList",["$parse","$timeout","dndDropEffectWorkaround","dndDragTypeWorkaround","dndService",function(e,n,r,t,a){return function(d,i,o){function g(e,n,r){var t=m?e.offsetX||e.layerX:e.offsetY||e.layerY,a=m?n.offsetWidth:n.offsetHeight,d=m?n.offsetLeft:n.offsetTop;return d=r?d:0,d+a/2>t}function f(){return Array.prototype.indexOf.call(D.children,v)}function l(e){if(!t.isDragging&&!E)return!1;if(!c(e.dataTransfer.types))return!1;if(o.dndAllowedTypes&&t.isDragging){var n=d.$eval(o.dndAllowedTypes);if(angular.isArray(n)&&-1===n.indexOf(t.dragType))return!1}return o.dndDisableIf&&d.$eval(o.dndDisableIf)?!1:!0}function s(){return p.remove(),i.removeClass("dndDragover"),!0}function u(n,r,a){return e(n)(d,{event:r,index:f(),item:a||void 0,external:!t.isDragging,type:t.isDragging?t.dragType:void 0})}function c(e){if(!e)return!0;for(var n=0;n<e.length;n++)if("Text"===e[n]||"text/plain"===e[n])return!0;return!1}var p=angular.element("<li class='dndPlaceholder'><div class='dndPlaceholder-inner'></div></li>"),v=p[0],D=i[0],m=o.dndHorizontalList&&d.$eval(o.dndHorizontalList),E=o.dndExternalSources&&d.$eval(o.dndExternalSources);i.on("dragover",function(e){if(e=e.originalEvent||e,!l(e))return!0;if(p.css({height:a.getDraggingElementHeight(),margin:a.getDraggingElement().css("margin"),padding:a.getDraggingElement().css("padding")}),v.parentNode!=D&&i.append(p),e.target!==D){for(var n=e.target;n.parentNode!==D&&n.parentNode;)n=n.parentNode;n.parentNode===D&&n!==v&&(g(e,n)?D.insertBefore(v,n):D.insertBefore(v,n.nextSibling))}else if(g(e,v,!0))for(;v.previousElementSibling&&(g(e,v.previousElementSibling,!0)||0===v.previousElementSibling.offsetHeight);)D.insertBefore(v,v.previousElementSibling);else for(;v.nextElementSibling&&!g(e,v.nextElementSibling,!0);)D.insertBefore(v,v.nextElementSibling.nextElementSibling);return o.dndDragover&&!u(o.dndDragover,e)?s():(i.addClass("dndDragover"),e.preventDefault(),e.stopPropagation(),!1)}),i.on("drop",function(e){if(e=e.originalEvent||e,!l(e))return!0;e.preventDefault();var n=e.dataTransfer.getData("Text")||e.dataTransfer.getData("text/plain"),t;try{t=JSON.parse(n)}catch(a){return s()}if(o.dndDrop&&(t=u(o.dndDrop,e,t),!t))return s();var i=d.$eval(o.dndList);return d.$apply(function(){i.splice(f(),0,t)}),r.dropEffect="none"===e.dataTransfer.dropEffect?"copy"===e.dataTransfer.effectAllowed||"move"===e.dataTransfer.effectAllowed?e.dataTransfer.effectAllowed:e.ctrlKey?"copy":"move":e.dataTransfer.dropEffect,s(),e.stopPropagation(),!1}),i.on("dragleave",function(e){e=e.originalEvent||e,u(o.dndDragleave,e),i.removeClass("dndDragover"),n(function(){i.hasClass("dndDragover")||p.remove()},100)})}}]).factory("dndDragTypeWorkaround",function(){return{}}).factory("dndDropEffectWorkaround",function(){return{}});